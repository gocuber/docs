<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	
<title>数据库查询结构器 CubePHP框架2.0开发文档 CubePHP框架 - 更好、更快、更强的PHP开发框架 - CubePHP官方网站</title>
<meta name="keywords" content="数据库查询结构器,CubePHP框架2.0开发文档,CubePHP框架,CubePHP,PHP框架,MVC框架,PHPMVC框架,gocuber,CubePHP框架 - 更好、更快、更强的PHP开发框架 - CubePHP官方网站">
<meta name="description" content="数据库查询结构器,CubePHP框架2.0开发文档,CubePHP框架,CubePHP,PHP框架,MVC框架,PHPMVC框架,gocuber,CubePHP框架 - 更好、更快、更强的PHP开发框架 - CubePHP官方网站">
<link href="/res/cube/css/style.css" rel="stylesheet" type="text/css" />

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2df9ce934dc484bd6d51074b34da2854";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>





</head>
<body>


<div class="cube-container cube-header">
	<div class="site">
		<div class="title"><a href="/" title="CubePHP框架">CubePHP框架</a><em>Beta</em></div>
		<div class="subtitle">—— 更好、更快、更强的PHP开发框架</div>
	</div>
	<div class="logo"><a href="/" title="CubePHP"><img src="/res/cube/images/logo1.jpg" alt="CubePHP" /></a></div>
</div>

<div class="cube-nav">
	<div class="cube-container">
		<div class="cube-nav-brand"><a href="/">Cube</a></div>
		<div class="cube-nav-toggle"><div><span></span><span></span><span></span></div></div>
		<div class="cube-navbar">
			<ul class="cube-nav-left">
				<li><a href="/" title="CubePHP框架官方首页">首页</a></li>
				<li><a href="/download/" title="CubePHP框架下载">下载</a></li>
				<li><a href="/guide/2.0/" title="CubePHP框架开发文档" class="active">开发文档</a></li>
				<li><a href="/code/" title="CubePHP框架相关代码">代码</a></li>
				<li><a href="/extend/" title="CubePHP框架扩展">扩展</a></li>
				<li><a href="/demo/" title="CubePHP框架演示">演示</a></li>
			</ul>
			
		</div>
	</div>
	<div class="cube-clear"></div>
</div>

<div class="cube-container">
<div class="cube-breadcrumb">
	<a href="/">首页</a>
	 &raquo; <a href="/guide/">开发文档</a> &raquo; <a href="/guide/2.0/">2.0</a> &raquo; 数据库查询结构器</div>
</div>

<div class="cube-container cube-change-layout">

    <div class="cube-big-layout cube-guide">
    <div class="cube-block">
		<div class="cube-title">数据库查询结构器</div>
		<div class="h1">数据库查询结构器</div>

<ul class="cube-catalog">
	<li><a href="#select"># 查询</a></li>
	<ul>
		<li><a href="#name"># name() 指定表名</a></li>
		<li><a href="#get"># get() 查询多条记录</a></li>
		<li><a href="#hash"># hash() 查询多条记录</a></li>
		<li><a href="#line"># line() 查询单条记录</a></li>
		<li><a href="#val"># val() 查询一个字段</a></li>
		<li><a href="#count"># count() 总数 max() 最大 min() 最小 avg() 平均 sum() 求和</a></li>
		<li><a href="#where"># where() 查询条件</a></li>
		<li><a href="#andwhere"># andWhere() 追加条件</a></li>
		<li><a href="#orwhere"># orWhere() 追加条件</a></li>
		<li><a href="#groupby"># groupBy() 分组</a></li>
		<li><a href="#having"># having() 子句</a></li>
		<li><a href="#orderby"># orderBy() 排序</a></li>
		<li><a href="#limit"># offset() 与 limit() limit语句</a></li>
		<li><a href="#page"># page() 分页</a></li>
		<li><a href="#innerjoin"># innerJoin() 联表查询</a></li>
		<li><a href="#leftjoin"># leftJoin() 联表查询</a></li>
		<li><a href="#rightjoin"># rightJoin() 联表查询</a></li>
		<li><a href="#field"># field() 查询字段</a></li>
		<li><a href="#query"># query() 执行查询</a></li>
	</ul>
	<li><a href="#insert"># 增加</a></li>
	<li><a href="#delete"># 删除</a></li>
	<li><a href="#update"># 修改</a></li>
</ul>

<div class="h2"><a name="select">#</a> 查询</div>

<div class="h3"><a name="name">name() 指定表名</a></div>
<p class="text">　　使用 name() 方法指定数据库表名称；</p>

<pre class="brush: php;">
DB::connect()->name('user');

DB::connect()->name('article');
</pre>


<div class="h3"><a name="get">get() 查询多条记录</a></div>
<pre class="brush: php;">

// select id,name from user

$list = DB::connect()->name('user')->get('id,name');
print_r($list);

array(
	array('id'=>1,'name'=>'name1'),
	array('id'=>2,'name'=>'name2'),
	// ..
);
</pre>

<p class="text">　　get() 方法与 select() 方法返回的结果一样；如下，返回的结果 $list 是一样的；</p>

<pre class="brush: php;">
$list = DB::connect()->select("select id,name from user");
print_r($list);

array(
	array('id'=>1,'name'=>'name1'),
	array('id'=>2,'name'=>'name2'),
	// ..
);
</pre>


<div class="h3"><a name="hash">hash() 查询多条记录</a></div>

<p class="text">　　有时候你需要以某字段做为key返回；</p>

<pre class="brush: php;">
$list = DB::connect()->name('user')->hash('id','name,date');
print_r($list);

array(
	'1' => array('name'=>'name1','date'=>'2010-10-10'),
	'2' => array('name'=>'name2','date'=>'2010-10-11'),
	// ..
);

//或者直接返回一个 key value 格式的hash数组
$list = DB::connect()->name('user')->hash('id','name');
print_r($list);

array(
	'1' => 'name1',
	'2' => 'name2',
	// ..
);
</pre>

<div class="h3"><a name="line">line() 查询单条记录</a></div>
<pre class="brush: php;">

// select id,name from user limit 1

$line = DB::connect()->name('user')->line('id,name');
print_r($line);

array('id'=>1,'name'=>'name1');
</pre>


<div class="h3"><a name="val">val() 查询一个字段</a></div>
<pre class="brush: php;">

// select name from user limit 1

$val = DB::connect()->name('user')->val('name');

echo $val; //name1
</pre>


<div class="h3"><a name="count">count() 总数 max() 最大 min() 最小 avg() 平均 sum() 求和</a></div>
<pre class="brush: php;">

// count() 总数
$val = DB::connect()->name('user')->count();
// 或
$val = DB::connect()->name('user')->val('count(*)');

// max() 最大
$val = DB::connect()->name('user')->max('id');
// 或
$val = DB::connect()->name('user')->val('max(id)');

// min() 最小
$val = DB::connect()->name('user')->min('id');
// 或
$val = DB::connect()->name('user')->val('min(id)');

// avg() 平均
$val = DB::connect()->name('user')->avg('id');
// 或
$val = DB::connect()->name('user')->val('avg(id)');

// sum() 求和
$val = DB::connect()->name('user')->sum('price');
// 或
$val = DB::connect()->name('user')->val('sum(price)');

</pre>


<div class="h3"><a name="where">where() where条件</a></div>

<p class="text">　　where() 方法三种调用格式；如下：</p>

<p class="text">　　一、字符串格式：</p>
<pre class="brush: php;">

	// where id = 1 and status = 1
	$db->where("id = 1 and status = 1");

</pre>

<p class="text">　　二、hash格式与数组格式：</p>
<pre class="brush: php;">

	// hash格式 [ key=>value, key=>value, ... ]

	// where id = 1
	$db->where([ 'id'=>1 ]);

	// where id in (1,2)
	$db->where([ 'id'=>[1,2] ]);

	// where id in (1,2) and status = 1
	$db->where([ 'id'=>[1,2], 'status'=>1 ]);


	// 数组格式 [ [], [], ... ]

	// where id = 1
	$db->where([ ['id','=',1] ]);

	// where id > 1
	$db->where([ ['id','>',1] ]);

	// where id = 1
	$db->where([ ['id',1] ]); // " = " 可以省略

	// where id in (1,2)
	$db->where([ ['id','in',[1,2]] ]);

	// where id > 1 and status = 1
	$db->where([ ['id','>',1], ['status',1] ]);

	// where id > 1 and status = 1
	$db->where([ ['id','>',1], ['status'=>1] ]); // 可以写成 key=>value 格式

	// where id > 1 and status = 1
	$db->where([ ['id','>',1], 'status'=>1 ]);   // 又一个 key=>value 格式 KV格式可省略[]

</pre>

<p class="text">
　　三、组合嵌套格式：[ 'and|or', [], [] ... ]<br>
　　'and|or' 可省略，省略默认为 and，如果省略'and|or'实际上就是上面第二种格式；<br>
　　同样的上面第二种格式 加上 'and|or' 就是组合嵌套格式；<br>
</p>
<pre class="brush: php;">

	// 格式 [ 'and|or', [], [] ... ]

	$db->where([ 'and', 'id'=>1, 'status'=>1 ]); // id=1 and status=1
	$db->where([ 'and', ['id','=',1], ['status','=',1] ]); // id=1 and status=1

	$db->where([ 'and', ['id',1], ['status',1] ]); // id=1 and status=1
	$db->where([ 'and', 'id'=>[1,2,3], 'status'=>1 ]); // id in (1,2,3) and status=1
	
	$db->where([ 'or', 'id'=>1, ['status','>',1] ]); // id=1 or status>1

	// 嵌套

	// where (id = 1 or status = 1) and (a = 1 or b = 1)
	$db->where([ 'and', ['or','id'=>1,'status'=>1], ['or','a'=>1,'b'=>1] ]);

	// where id>1 and (status=1 or name='name1')
	$db->where(['and', ['id','>',1], ['or','status'=>1,'name'=>'name1']]);

</pre>

<p class="text">
	　　相信你已经发现以上三种格式可以总结为一种：[ 'and|or', 表达式1, 表达式2 ... ]<br>
	　　'and|or' 可省略，省略默认为 and；<br>
	　　表达式可以是 字符串 或 key=>value 或 数组 []；<br>
</p>
<pre class="brush: php;">

	// where a in (1,2) or b = 1
	$db->where([ 'or', ['a'=>[1,2]], ['b'=>1] ]); // key=>value

	// where a in (1,2) or b = 1
	$db->where([ 'or', 'a'=>[1,2], 'b'=>1 ]); // key=>value 可以省略 []
	
	// where a = 1 or b = 1
	$db->where([ 'or', ['a','=',1], ['b','=',1] ]); // 数组 []

	// where a = 1 or b = 1
	$db->where([ 'or', ['a',1], ['b',1] ]); // " = " 可以省略


	// 最后使用 get() line() val() 返回结果
	$line = $db->name('user')->where([ 'id'=>1, 'status'=>1 ])->line();
	print_r($line);

</pre>

<p class="text">　　需要注意的是直接传字符串的时候不会对字符进行转义；除非你能确保你的sql是安全的；</p>


<div class="h3"><a name="andwhere">andWhere() 追加条件</a></div>
<pre class="brush: php;">

	// where id = 1 and status = 1
	$db->where([ 'id'=>1 ])->andWhere([ 'status'=>1 ]);

	// where id = 1 and status = 1 and name = 'abc' and username = 'user1'
	$db->where([ 'id'=>1, 'status'=>1 ])
		->andWhere([ 'name'=>'abc' ])
		->andWhere([ 'username'=>'user1' ]);

</pre>


<div class="h3"><a name="orwhere">orWhere() 追加条件</a></div>
<pre class="brush: php;">

	// where id = 1 or status = 1
	$db->where([ 'id'=>1 ])->orWhere([ 'status'=>1 ]);

	// where check = 1 or status = 1
	$db->where([ 'check'=>1 ])->orWhere([ 'status'=>1 ]);

</pre>

<p class="text">　　where() andWhere() orWhere() 三个方法的参数是一样的；</p>

<div class="h3"><a name="groupby">groupBy() 分组</a></div>
<pre class="brush: php;">
// group by cid
DB::connect()->name('user')->groupBy('cid')->get();

// group by cid,pid
DB::connect()->name('user')->groupBy('cid,pid')->get();
</pre>


<div class="h3"><a name="having">having() 子句</a></div>
<pre class="brush: php;">
// group by cid having sum(price) > 1000
DB::connect()->name('user')->groupBy('cid')->having('sum(price) > 1000')->get();
</pre>


<div class="h3"><a name="orderby">orderBy() 排序</a></div>
<pre class="brush: php;">
// order by id desc
DB::connect()->name('user')->orderBy('id desc')->get();

// order by status desc,id desc
DB::connect()->name('user')->orderBy('status desc,id desc')->get();
</pre>

<div class="h3"><a name="limit">offset() 与 limit() limit语句</a></div>
<pre class="brush: php;">
DB::connect()->name('user')->limit(10)->get();                // limit 10
DB::connect()->name('user')->offset(20)->limit(10)->get();    // limit 20,10
</pre>

<div class="h3"><a name="page">page() 分页</a></div>
<pre class="brush: php;">
// 查询第一页数据 每页20条
DB::connect()->name('user')->page(1, 20)->get();    // limit 0,20

// 查询第二页数据 每页20条
DB::connect()->name('user')->page(2, 20)->get();    // limit 20,20
</pre>


<div class="h3"><a name="innerjoin">innerJoin() 联表查询</a></div>
<pre class="brush: php;">
// ... from user inner join group on user.gid = group.gid
DB::connect()->name('user')->innerJoin('group', 'user.gid = group.gid')->get();

// 多表 join
DB::connect()->name('user')
	->innerJoin('article', 'user.uid = article.uid')
	->innerJoin('class', 'user.uid = class.uid')->get();

</pre>


<div class="h3"><a name="leftjoin">leftJoin() 联表查询</a></div>
<pre class="brush: php;">
// ... from user left join group on user.gid = group.gid
DB::connect()->name('user')->leftJoin('group', 'user.gid = group.gid')->get();
</pre>


<div class="h3"><a name="rightjoin">rightJoin() 联表查询</a></div>
<pre class="brush: php;">
// ... from user right join group on user.gid = group.gid
DB::connect()->name('user')->rightJoin('group', 'user.gid = group.gid')->get();
</pre>


<div class="h3"><a name="field">field() 查询字段</a></div>
<pre class="brush: php;">
// select id,name from user
DB::connect()->name('user')->field('id,name')->get();
</pre>


<div class="h3"><a name="query">query() 执行sql查询</a></div>

<p class="text">　　当需要处理大数据的时候，像 get() select() 这样的方法就不太合适了，因为它们会把所有数据都读取到内存上。为了保持较低的内存消耗，使用 query() fetch()<br />　　用法如下：</p>

<pre class="brush: php;">
$db = DB::connect();
$query = $db->name('user')->field('id,name')->where([ 'status'=>1 ])->query();
for (; $value = $db->fetch($query); ) {
    // ...
}
</pre>

<p class="text">　　query() 只会执行查询sql语句；并不会返回查询结果；如果想要得到查询结果，还需使用 fetch() 方法；</p>


<div class="h2"><a name="insert">#</a> 增加</div>
<p class="text">　　使用 insert() 方法增加一条记录；与之前使用基础里介绍的使用方法略有不同；其实就是两种不同的使用方法；可以直接传sql语句；也可以传一个 key=>value 字段对值 的数组；如下：</p>
<pre class="brush: php;">
// 直接写sql
$db->insert("insert into user (name,status) values ( ? , ? )", [ 'abc',1 ]);

// 或者传一个数组
$db->name('user')->insert([ 'name'=>'abc', 'status'=>1 ]);

</pre>
<p class="text">　　insert() 方法返回最后插入的自增主键id，如果当前表有主键的话；如果想要插入一条空记录，返回最后 lastid 可以直接传一个空数组 insert([]) 如下：</p>

<pre class="brush: php;">
$lastid = $db->name('user')->insert([]);
</pre>


<div class="h2"><a name="delete">#</a> 删除</div>
<p class="text">　　同样的也是两种用法</p>
<pre class="brush: php;">

$db->delete("delete from user where id= :id ", [ 'id'=>10 ]);

$db->name('user')->where([ 'id'=>10 ])->delete();
$db->name('user')->where([ 'id'=>10 ])->limit(1)->delete();

</pre>


<div class="h2"><a name="update">#</a> 修改</div>
<pre class="brush: php;">

$db->update("update user set status= ? where name= ? ", [ 1,'abc' ]);

$db->name('user')->where([ 'name'=>'abc' ])->update([ 'status'=>1 ]);

</pre>

<p class="text">　　delete() 和 update() 方法返回影响行数；</p>



<br /><br /><br /><br />
	</div>
	</div><!-- /big -->

	
    <div class="cube-small-layout">
    <div class="cube-block">

    		<div class="cube-title">开发文档</div>
		<ul class="cube-menu">
		<li>开始</li><ul><li><a href="/guide/2.0/about/">简介</a></li><li><a href="/guide/2.0/down/">下载和安装</a></li><li><a href="/guide/2.0/app/">创建第一个应用</a></li></ul><li>基础知识</li><ul><li><a href="/guide/2.0/directory/">目录结构</a></li><li><a href="/guide/2.0/entrance/">入口文件</a></li><li><a href="/guide/2.0/urlmodel/">URL模式</a></li><li><a href="/guide/2.0/rewrite/">URL重写</a></li><li><a href="/guide/2.0/controller/">Controller 控制器</a></li><li><a href="/guide/2.0/view/">View 视图模板</a></li><li><a href="/guide/2.0/model/">Model 模型</a></li><li><a href="/guide/2.0/route/">URL路由</a></li><li><a href="/guide/2.0/autoload/">类自动加载</a></li><li><a href="/guide/2.0/rule/">开发规范</a></li><li><a href="/guide/2.0/exception/">异常处理</a></li></ul><li>数据库</li><ul><li><a href="/guide/2.0/dbbase/">数据库配置与使用基础</a></li><li><a href="/guide/2.0/dbquery/">数据库查询结构器</a></li><li><a href="/guide/2.0/dbmodel/">数据库模型(model)的使用</a></li><li><a href="/guide/2.0/dbtransaction/">数据库事务处理</a></li></ul><li>缓存</li><ul><li><a href="/guide/2.0/memcache/">Memcache</a></li><li><a href="/guide/2.0/redis/">Redis</a></li><li><a href="/guide/2.0/filecache/">文件缓存</a></li><li><a href="/guide/2.0/cachesession/">使用缓存存储SESSION</a></li></ul><li>搜索引擎</li><ul><li><a href="/guide/2.0/elasticsearch/">Elasticsearch</a></li></ul><li>类库及函数</li><ul><li><a href="/guide/2.0/func/">系统函数说明</a></li><li><a href="/guide/2.0/class/">系统类库说明</a></li><li><a href="/guide/2.0/session/">SESSION使用</a></li><li><a href="/guide/2.0/cookie/">COOKIE使用</a></li></ul><li>CLI命令行</li><ul><li><a href="/guide/2.0/cli/">以命令行方式运行</a></li></ul><li>扩展</li><ul><li><a href="/guide/2.0/smarty/">使用Smarty</a></li><li><a href="/guide/2.0/lib/">使用第三方库</a></li><li><a href="/guide/2.0/sae/">SAE环境下开发</a></li></ul>		</ul>
	
    </div>
    </div><!-- /small -->

</div><!-- /cube-container -->


	<div class="cube-container cube-footer">
		意见反馈邮箱 cuber@gocuber.com<br />
		版权所有 <span>&copy;</span> 2012-2018 goCuber.com Powered by <a href="/">CubePHP</a>
	</div>
	<div class="cube-top">TOP</div>
	

<script language="javascript" type="text/javascript">
/* 全局变量 */
var G = {
	'cubeUrl' : '/',
	'resUrl' : '/res/',
	'publicKey' : 0
};
</script>

<div class="cube-dn"><script src="https://s19.cnzz.com/z_stat.php?id=1272829783&web_id=1272829783" language="JavaScript"></script></div>

<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script src="/res/cube/js/global.js"></script>

<script src="/res/global/js/syntaxhighlighter_2.1.382/scripts/shCore.js"></script>
<script src="/res/global/js/syntaxhighlighter_2.1.382/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="/res/global/js/syntaxhighlighter_2.1.382/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="/res/global/js/syntaxhighlighter_2.1.382/styles/shThemeDefault.css"/>
<script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = '/res/global/js/syntaxhighlighter_2.1.382/scripts/clipboard.swf';
SyntaxHighlighter.all();
</script>

</body>
</html>
